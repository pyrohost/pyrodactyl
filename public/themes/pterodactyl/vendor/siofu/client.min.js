/* Socket IO File Upload Client-Side Library
 *   Copyright (C) 2015 Shane Carr and others
 *   Released under the X11 License
 * For more information, visit: https://github.com/vote539/socketio-file-upload
 */
((g, d, f) => {
	"function" === typeof define && define.amd
		? define([], f)
		: "object" === typeof module && module.exports
			? (module.exports = f())
			: (g[d] = f());
})(this, "SocketIOFileUpload", () => function (g) {
		if (!window.File || !window.FileReader)
			throw Error("Socket.IO File Upload: Browser Not Supported");
		window.siofu_global ||
			(window.siofu_global = { instances: 0, downloads: 0 });
		var f = {},
			p = {},
			y = {},
			q = {},
			h = {};
		this.fileInputElementId = "siofu_input_" + siofu_global.instances++;
		this.resetFileInputs = !0;
		this.useText = !1;
		this.serializedOctets = !1;
		this.useBuffer = !0;
		this.chunkSize = 102400;
		var t = (a, b) => {
				var c = document.createEvent("Event");
				c.initEvent(a, !1, !1);
				for (var v in b) Object.hasOwn(b, v) && (c[v] = b[v]);
				return this.dispatchEvent(c);
			},
			r = [],
			e = function (a, b, c, d) {
				a.addEventListener(b, c, d);
				r.push(arguments);
			},
			z = (a, b, c, d) => {
				a.removeEventListener && a.removeEventListener(b, c, d);
			},
			B = function () {
				for (var a = r.length - 1; 0 <= a; a--) z.apply(this, r[a]);
				r = [];
			},
			C = (a) => {
				if (null !== this.maxFileSize && a.size > this.maxFileSize)
					t("error", {
						file: a,
						message:
							"Attempt by client to upload file exceeding the maximum file size",
						code: 1,
					});
				else if (t("start", { file: a })) {
					var b = new FileReader(),
						c = siofu_global.downloads++,
						f = !1,
						h = this.useText,
						w = 0,
						r;
					b._realReader && (b = b._realReader);
					p[c] = a;
					var u = { id: c },
						x = this.chunkSize;
					if (x >= a.size || 0 >= x) x = a.size;
					var n = () => {
							if (!u.abort) {
								var c = a.slice(w, Math.min(w + x, a.size));
								h ? b.readAsText(c) : b.readAsArrayBuffer(c);
							}
						},
						A = (e) => {
							if (!u.abort) {
								var v = Math.min(w + x, a.size);
								a: {
									var p = w;
									e = e.target.result;
									var n = !1;
									if (!h)
										try {
											var l = new Uint8Array(e);
											if (this.serializedOctets) e = l;
											else if (this.useBuffer) e = l.buffer;
											else {
												var n = !0,
													m,
													q = l.buffer.byteLength,
													k = "";
												for (m = 0; m < q; m += 3)
													(k +=
														"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
															l[m] >> 2
														]),
														(k +=
															"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
																((l[m] & 3) << 4) | (l[m + 1] >> 4)
															]),
														(k +=
															"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
																((l[m + 1] & 15) << 2) | (l[m + 2] >> 6)
															]),
														(k +=
															"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
																l[m + 2] & 63
															]);
												2 === q % 3
													? (k = k.substring(0, k.length - 1) + "=")
													: 1 === q % 3 &&
														(k = k.substring(0, k.length - 2) + "==");
												e = k;
											}
										} catch (E) {
											g.emit("siofu_done", { id: c, interrupt: !0 });
											break a;
										}
									g.emit("siofu_progress", {
										id: c,
										size: a.size,
										start: p,
										end: v,
										content: e,
										base64: n,
									});
								}
								t("progress", { file: a, bytesLoaded: v, name: r });
								w += x;
								w >= a.size &&
									(g.emit("siofu_done", { id: c }),
									t("load", { file: a, reader: b, name: r }),
									(f = !0));
							}
						};
					e(b, "load", A);
					e(b, "error", () => {
						g.emit("siofu_done", { id: c, interrupt: !0 });
						z(b, "load", A);
					});
					e(b, "abort", () => {
						g.emit("siofu_done", { id: c, interrupt: !0 });
						z(b, "load", A);
					});
					g.emit("siofu_start", {
						name: a.name,
						mtime: a.lastModified,
						meta: a.meta,
						size: a.size,
						encoding: h ? "text" : "octet",
						id: c,
					});
					q[c] = (a) => {
						r = a;
						n();
					};
					y[c] = () => {
						f || n();
					};
					return u;
				}
			},
			u = (a) => {
				if (0 !== a.length) {
					for (var b = 0; b < a.length; b++) a[b].meta || (a[b].meta = {});
					if (t("choose", { files: a }))
						for (b = 0; b < a.length; b++) {
							var c = C(a[b]);
							h[c.id] = c;
						}
				}
			},
			n = (a) => {
				var b = a.target.files || a.dataTransfer.files;
				a.preventDefault();
				u(b);
				if (this.resetFileInputs) {
					try {
						a.target.value = "";
					} catch (D) {}
					if (a.target.value) {
						var b = document.createElement("form"),
							c = a.target.parentNode,
							e = a.target.nextSibling;
						b.appendChild(a.target);
						b.reset();
						c.insertBefore(a.target, e);
					}
				}
			};
		this.submitFiles = (a) => {
			a && u(a);
		};
		this.listenOnSubmit = (a, b) => {
			b.files &&
				e(
					a,
					"click",
					() => {
						u(b.files);
					},
					!1,
				);
		};
		this.listenOnArraySubmit = function (a, b) {
			for (var c in b) this.listenOnSubmit(a, b[c]);
		};
		this.listenOnInput = (a) => {
			a.files && e(a, "change", n, !1);
		};
		this.listenOnDrop = (a) => {
			e(
				a,
				"dragover",
				(a) => {
					a.preventDefault();
				},
				!1,
			);
			e(a, "drop", n);
		};
		this.prompt = () => {
			var a;
			a = document.getElementById(this.fileInputElementId);
			a ||
				((a = document.createElement("input")),
				a.setAttribute("type", "file"),
				a.setAttribute("id", this.fileInputElementId),
				(a.style.display = "none"),
				document.body.appendChild(a));
			e(a, "change", n, !1);
			var b = document.createEvent("MouseEvents");
			b.initMouseEvent(
				"click",
				!0,
				!0,
				window,
				0,
				0,
				0,
				0,
				0,
				!1,
				!1,
				!1,
				!1,
				0,
				null,
			);
			a.dispatchEvent(b);
		};
		this.destroy = () => {
			B();
			var a = document.getElementById(this.fileInputElementId);
			a && a.parentNode.removeChild(a);
			for (var b in h) Object.hasOwn(h, b) && (h[b].abort = !0);
			h = q = p = f = null;
		};
		this.addEventListener = (a, b) => {
			f[a] || (f[a] = []);
			f[a].push(b);
		};
		this.removeEventListener = (a, b) => {
			if (!f[a]) return !1;
			for (var c = 0; c < f[a].length; c++)
				if (f[a][c] === b) return f[a].splice(c, 1), !0;
			return !1;
		};
		this.dispatchEvent = (a) => {
			var b = f[a.type];
			if (!b) return !0;
			for (var c = !0, d = 0; d < b.length; d++) !1 === b[d](a) && (c = !1);
			return c;
		};
		e(g, "siofu_chunk", (a) => {
			if (y[a.id]) y[a.id]();
		});
		e(g, "siofu_ready", (a) => {
			if (q[a.id]) q[a.id](a.name);
		});
		e(g, "siofu_complete", (a) => {
			p[a.id] &&
				t("complete", { file: p[a.id], detail: a.detail, success: a.success });
		});
		e(g, "siofu_error", (a) => {
			p[a.id] &&
				(t("error", { file: p[a.id], message: a.message, code: 0 }),
				h && (h[a.id].abort = !0));
		});
	});
